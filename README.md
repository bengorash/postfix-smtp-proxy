## Postfix SMTP Proxy

This project implements a custom SMTP proxy using Postfix, integrated with a Flask-based blacklist service to filter emails based on sender-recipient pairs. The proxy relays emails to an external SMTP server (e.g., Gmail) and supports TLS for secure communication. It runs in a Dockerized environment using Docker Compose, with a health monitoring script to ensure the blacklist service is operational.

## Features

- **SMTP Proxy**: Relays emails via Postfix to an external SMTP server (default: Gmail).
- **Blacklist Filtering**: Blocks emails based on a configurable sender-recipient blacklist.
- **TLS Support**: Secures incoming connections with self-signed certificates (replaceable with Let's Encrypt for production).
- **Dockerized**: Runs as two services (`smtp_proxy` and `blacklist_service`) with Docker Compose.
- **Health Monitoring**: Periodically checks the blacklist service's health.

## Prerequisites

- **Docker**: Installed and running (version 20.10+ recommended).
- **Docker Compose**: Installed (version 1.29+ recommended).
- **gcloud CLI**: For deployment to a Google Cloud VM (optional).
- **Python**: For local development (optional, version 3.11+).

## Folder Structure

```
/app/togotrek/postfix/
├── README.md                # Project documentation (this file)
├── docker-compose.yml       # Docker Compose configuration
├── cert.pem                 # Self-signed TLS certificate
├── key.pem                  # Self-signed TLS private key
├── blacklist_service/       # Blacklist service directory
│   ├── Dockerfile           # Dockerfile for the blacklist service
│   ├── blacklist_service.py # Flask app for blacklist policy
│   ├── setup_env.py         # Environment variable configuration
│   ├── logging_config.py    # Logging setup
│   ├── requirements.txt     # Python dependencies (Flask)
│   └── sender_blacklist     # Blacklist file (e.g., "ben@togotrek.com:ven@i8studios.com REJECT Blocked by policy")
└── smtp_proxy/              # SMTP proxy directory
    ├── Dockerfile           # Dockerfile for the SMTP proxy
    ├── config/              # Postfix configuration files
    │   ├── main.cf          # Main Postfix configuration
    │   ├── master.cf        # Postfix service definitions
    │   ├── supervisord.conf # Supervisor configuration for managing processes
    │   └── sasl_passwd      # Gmail SMTP credentials (optional, generated by entrypoint.sh)
    └── scripts/             # Scripts for SMTP proxy
        ├── health_monitor.py # Health monitoring script for blacklist service
        └── entrypoint.sh     # Startup script for Postfix and Supervisor
```

### File Details

- **`cert.pem` and `key.pem`**: Self-signed certificates for TLS. Replace with production certificates (e.g., from Let's Encrypt) as needed.
- **`blacklist_service/sender_blacklist`**: Text file listing blocked sender-recipient pairs.
- **`smtp_proxy/config/main.cf`**: Configures Postfix to relay emails via Gmail and use the blacklist service.
- **`smtp_proxy/config/master.cf`**: Defines the SMTP service on port 2525.
- **`smtp_proxy/scripts/health_monitor.py`**: Monitors the blacklist service's health via HTTP requests.

## Setup Instructions

### Local Development

1. **Clone or Prepare the Directory**:

   - Ensure your local directory matches the structure above.
   - Generate self-signed certificates if missing:
     ```bash
     openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365 -nodes -subj "/CN=smtp.togotrek.com"
     ```
2. **Build and Run**:

   ```bash
   cd /path/to/your/project/postfix
   docker-compose up -d --build
   ```
3. **Verify Services**:

   ```bash
   docker-compose ps
   ```

   - Expect `postfix_smtp_proxy_1` and `postfix_blacklist_service_1` to be `Up`.
4. **Check Logs**:

   ```bash
   docker-compose logs -f
   ```

### Deployment to Google Cloud VM

1. **Prepare VM**:

   - Create a VM (e.g., `smtp-proxy`) in Google Cloud (zone: `us-west1-c`).
   - Install Docker and Docker Compose on the VM.
2. **Copy Files**:

   - Use the provided PowerShell script (`copy_to_vm.ps1`) to transfer the project to the VM:
     ```powershell
     $sourceDir = "E:\Projects\TogoTrek\postfix-smtp-gateway\postfix"
     $remoteUser = "VeniaminGorash"
     $remoteInstance = "smtp-proxy"
     $remoteBasePath = "/app/togotrek/postfix/"
     $zone = "us-west1-c"

     $items = Get-ChildItem -Path $sourceDir -Recurse

     foreach ($item in $items) {
         $relativePath = $item.FullName.Substring($sourceDir.Length + 1)
         $remotePath = "$remoteBasePath$relativePath" -replace '\\', '/'
         if ($item.PSIsContainer) {
             Write-Host "Creating directory $remotePath..."
             $sshCommand = "gcloud compute ssh $remoteUser@$remoteInstance --zone=$zone --command=`"mkdir -p $remotePath`""
             Invoke-Expression $sshCommand
         } else {
             $localFilePath = $item.FullName
             $fileName = $item.Name
             Write-Host "Copying $fileName to $remotePath..."
             $scpCommand = "gcloud compute scp `"$localFilePath`" $remoteUser@$remoteInstance`:$remotePath --zone=$zone"
             Invoke-Expression $scpCommand
         }
     }
     ```
   - Run: `.\copy_to_vm.ps1`
3. **SSH into VM and Start**:

   ```bash
   gcloud compute ssh VeniaminGorash@smtp-proxy --zone=us-west1-c
   cd /app/togotrek/postfix
   docker-compose up -d --build
   ```

## Usage

- **Test SMTP Proxy**:

  ```bash
  swaks --to someone@example.com --from ben@togotrek.com --server localhost:2525 --tls
  ```

  - Emails to `ven@i8studios.com` or `bengorash@gmail.com` from `ben@togotrek.com` should be rejected per the blacklist.
- **Check Blacklist Service Health**:

  ```bash
  curl http://localhost:5000/health
  ```

  - Should return `healthy`.
- **View Logs**:

  - SMTP proxy logs: `/var/log/postfix/postfix.log` (inside container).
  - Blacklist service logs: `/app/togotrek/postfix/logs/blacklist.log`.

## Configuration

- **Environment Variables** (in `docker-compose.yml`):

  - `SMTP_USER` and `SMTP_PASS`: Gmail credentials for relaying emails.
  - `API_KEY`: Authentication key for blacklist service (default: `550e8400-e29b-41d4-a716-446655440000`).
  - `HOSTNAME`: SMTP server hostname (default: `smtp.togotrek.com`).
- **Blacklist**:

  - Edit `blacklist_service/sender_blacklist` to add or remove blocked pairs (format: `sender:recipient REJECT Blocked by policy`).
- **TLS Certificates**:

  - Replace `cert.pem` and `key.pem` with production certificates for secure deployment.

## Troubleshooting

- **Container Restarts**:
  - Check logs: `docker-compose logs -f`.
  - Inspect Postfix errors:
    ```bash
    docker exec -it postfix_smtp_proxy_1 cat /var/log/postfix/postfix.log
    ```


## Troubleshooting (Continued)

- **Postfix Configuration Errors**:

  - Run `postfix check` inside the container:
    ```bash
    docker exec -it postfix_smtp_proxy_1 /usr/sbin/postfix -c /etc/postfix check
    ```
  - Check `/var/log/postfix_check.log` for detailed output:
    ```bash
    docker exec -it postfix_smtp_proxy_1 cat /var/log/postfix_check.log
    ```
- **Health Monitor Failures**:

  - If the `health-monitor` process exits with code 127:
    ```bash
    docker exec -it postfix_smtp_proxy_1 cat /var/log/supervisor/health_monitor_error.log
    ```
  - Ensure Python and `requests` are installed:
    ```bash
    docker exec -it postfix_smtp_proxy_1 python3 -c "import requests"
    ```
- **TLS Issues**:

  - Verify certificates:
    ```bash
    docker exec -it postfix_smtp_proxy_1 openssl x509 -in /etc/postfix/cert.pem -text -noout
    docker exec -it postfix_smtp_proxy_1 openssl rsa -in /etc/postfix/key.pem -check
    ```
  - Test TLS connection:
    ```bash
    openssl s_client -connect localhost:2525 -starttls smtp
    ```

## Development Notes

- **Modifying Configuration**:

  - Edit `smtp_proxy/config/main.cf` or `master.cf` for Postfix settings, then rebuild:
    ```bash
    docker-compose up -d --build
    ```
  - Adjust `blacklist_service/sender_blacklist` to update blocked pairs without rebuilding (due to volume mount).
- **Adding Features**:

  - Extend `blacklist_service.py` for additional endpoints (e.g., dynamic blacklist updates).
  - Modify `health_monitor.py` to add alerts or metrics logging.

## Production Considerations

- **Certificates**: Replace self-signed `cert.pem` and `key.pem` with certificates from a trusted CA (e.g., Let’s Encrypt). See [Let’s Encrypt Setup](#lets-encrypt-setup) below.
- **Security**: Use a production WSGI server (e.g., Gunicorn) for `blacklist_service` instead of Flask’s development server.
- **Logging**: Configure log rotation for `/var/log/postfix/*` and `/app/togotrek/postfix/logs/*`.
- **Firewall**: Open ports 2525 (SMTP) and 5000 (blacklist service) only to necessary IPs.

### Let’s Encrypt Setup

1. Install Certbot on the VM:
   ```bash
   sudo apt update && sudo apt install certbot
   ```
2. Obtain certificates:
   ```bash
   sudo certbot certonly --standalone -d smtp.togotrek.com --email ben@togotrek.com --agree-tos --no-eff-email
   ```
3. Copy certificates to the project:
   ```bash
   cp /etc/letsencrypt/live/smtp.togotrek.com/fullchain.pem /app/togotrek/postfix/cert.pem
   cp /etc/letsencrypt/live/smtp.togotrek.com/privkey.pem /app/togotrek/postfix/key.pem
   ```
4. Update permissions:
   ```bash
   chmod 644 /app/togotrek/postfix/cert.pem
   chmod 600 /app/togotrek/postfix/key.pem
   ```
5. Rebuild and restart:
   ```bash
   docker-compose up -d --build
   ```

## Contributing

- Fork the repository (if hosted on a platform like GitHub).
- Submit pull requests with improvements or bug fixes.
- Report issues via email to `ben@togotrek.com` or your preferred channel.

## License

This project is unlicensed and provided as-is for personal or organizational use. Modify and distribute as needed.

## Acknowledgments

- Built with assistance from Grok 3 by xAI.
- Uses Postfix, Flask, and Supervisor for core functionality.

---

### Notes

- **Folder Structure**: Matches your current setup, with `cert.pem` and `key.pem` at the root and `sender_blacklist` under `blacklist_service/`.
- **Troubleshooting**: Includes commands you’ve used to debug, ensuring continuity with our work.
- **Production**: Added a basic Let’s Encrypt section based on our earlier discussions.

To add this to your project:

1. Create a file named `README.md` in `/app/togotrek/postfix/`.
2. Copy the content above into it.
3. Update the recursive copy script to include it:
   - It’s already covered by `$items = Get-ChildItem -Path $sourceDir -Recurse`, so no changes are needed unless you rename it.

Let me know if you’d like to tweak anything (e.g., add more sections, adjust tone, or include specific credits)! Ready to proceed with debugging the latest logs if needed—just share them!
